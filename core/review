# core/review.py
import json
from .model import call_qwen

def process_reviews(content, selected_roles, api_key, model):
    """å¤„ç†å¤šä¸ªè§’è‰²çš„è¯„å®¡"""
    if not content.strip():
        return "âš ï¸ è¯·ç²˜è´´æ–‡æ¡ˆå†…å®¹"
    if not api_key.strip():
        return "ðŸ”‘ è¯·åœ¨ä¸‹æ–¹è¾“å…¥ä½ çš„ DashScope API Key"
    if not selected_roles:
        return "ðŸ‘¥ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¯„å®¡è§’è‰²"
    
    results = []
    for role in selected_roles:
        system_prompt = role.get("system_prompt", "ä½ æ˜¯ä¸€ä½ä¸“ä¸šè¯„å®¡ã€‚")
        response = call_qwen(api_key, system_prompt, content, model)
        
        # å°è¯•è§£æž JSON
        try:
            data = json.loads(response)
            score = data.get("score", "N/A")
            comment = data.get("comment", response)
        except:
            # å¦‚æžœä¸æ˜¯ JSONï¼Œæˆªå–å‰100å­—
            score = "N/A"
            comment = response[:100] + "..." if len(response) > 100 else response
        
        results.append(f"**{role['name']}**ï¼š{score}/10 â€” {comment}")
    
    return "\n\n".join(results)
